<html>
<body>
    <video autoplay></video>
    <img src="">
    <canvas style="display: none;"></canvas>
    <button id='start' onclick='get_stream()'>start</button>
    <button id='capture' onclick='capture()'>capture</button>
    <form onsubmit='preprocess()' action='/hello' method="POST">
        <input id='data' name='data' style="display: none;">
        <input type='submit'>
    </form>
<script>

const constraints = {
    video: true
};
const video = document.querySelector('video');
const img = document.querySelector('img');
const canvas = document.createElement('canvas');

function get_stream() {
    video.style.display = 'block';
    img.style.display = 'none';
    canvas.style.display = 'none';
    navigator.mediaDevices.getUserMedia(constraints).
        then((stream) => {
            window.stream = stream;
            video.srcObject = stream;
        });
}

function capture() {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    img.src = canvas.toDataURL('image/png');

    if (window.stream)
        window.stream.getTracks().forEach(track => track.stop());

    video.style.display = 'none';
    img.style.display = 'block';
    canvas.style.display = 'block';
}

function preprocess() {
    document.getElementById('data').value = img.src.replace('data:image/png;base64,', '');
}

</script>
</body>
</html>

